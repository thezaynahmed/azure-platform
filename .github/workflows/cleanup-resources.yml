name: Cleanup Azure Resources

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to cleanup'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod
      companyPrefix:
        description: 'Company prefix used in deployment'
        required: true
        default: 'tmb'
        type: string
      location:
        description: 'Azure region where resources were deployed'
        required: true
        default: 'centralus'
        type: choice
        options:
          - centralus
          - eastus
          - eastus2
          - westus2
          - westeurope
          - northeurope
      cleanup_type:
        description: 'Type of cleanup to perform'
        required: true
        type: choice
        options:
          - specific-rg    # Delete specific resource groups
          - all-matching   # Delete all resource groups matching pattern
          - list-only      # List resources without deleting
      confirm_deletion:
        description: 'Type "DELETE" to confirm resource deletion'
        required: true
        type: string
      resource_groups:
        description: 'Specific resource groups to delete (comma-separated, optional)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  validate-cleanup-request:
    name: Validate Cleanup Request
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ github.event.inputs.environment }}
      companyPrefix: ${{ github.event.inputs.companyPrefix }}
      location: ${{ github.event.inputs.location }}
      cleanup_type: ${{ github.event.inputs.cleanup_type }}
      expected_rg_shared: ${{ steps.vars.outputs.expected_rg_shared }}
      expected_rg_vneta: ${{ steps.vars.outputs.expected_rg_vneta }}
      expected_rg_vnetb: ${{ steps.vars.outputs.expected_rg_vnetb }}

    steps:
    - name: Validate confirmation
      run: |
        if [[ "${{ github.event.inputs.confirm_deletion }}" != "DELETE" ]]; then
          echo "‚ùå Resource deletion not confirmed. Please type 'DELETE' to proceed."
          exit 1
        fi
        echo "‚úÖ Resource deletion confirmed"

    - name: Set expected resource group names
      id: vars
      run: |
        PREFIX="${{ github.event.inputs.companyPrefix }}"
        ENV="${{ github.event.inputs.environment }}"
        LOCATION="${{ github.event.inputs.location }}"

        echo "expected_rg_shared=rg-${PREFIX}-${ENV}-shared-${LOCATION}" >> $GITHUB_OUTPUT
        echo "expected_rg_vneta=rg-${PREFIX}-${ENV}-vneta-${LOCATION}" >> $GITHUB_OUTPUT
        echo "expected_rg_vnetb=rg-${PREFIX}-${ENV}-vnetb-${LOCATION}" >> $GITHUB_OUTPUT

        echo "Expected resource groups:"
        echo "- Shared: rg-${PREFIX}-${ENV}-shared-${LOCATION}"
        echo "- VNet A: rg-${PREFIX}-${ENV}-vneta-${LOCATION}"
        echo "- VNet B: rg-${PREFIX}-${ENV}-vnetb-${LOCATION}"

    - name: Validate environment safety
      run: |
        if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
          echo "‚ö†Ô∏è WARNING: This will delete PRODUCTION resources!"
          echo "‚ö†Ô∏è Ensure you have proper backups and approval for production cleanup."
          sleep 5
        fi

        if [[ "${{ github.event.inputs.cleanup_type }}" == "all-matching" ]]; then
          echo "‚ö†Ô∏è WARNING: 'all-matching' will delete ALL resource groups matching the pattern!"
          echo "‚ö†Ô∏è This includes any resource groups that start with 'rg-${{ github.event.inputs.companyPrefix }}-${{ github.event.inputs.environment }}-'"
          sleep 5
        fi

        echo "‚úÖ Environment safety check completed"

  list-resources:
    name: List Resources to be Deleted
    runs-on: ubuntu-latest
    needs: validate-cleanup-request

    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: List existing resource groups
      id: list-rgs
      run: |
        echo "üîç Listing existing resource groups for cleanup analysis..."

        PREFIX="${{ needs.validate-cleanup-request.outputs.companyPrefix }}"
        ENV="${{ needs.validate-cleanup-request.outputs.environment }}"

        if [[ "${{ needs.validate-cleanup-request.outputs.cleanup_type }}" == "specific-rg" ]]; then
          # List specific expected resource groups
          RG_LIST=("${{ needs.validate-cleanup-request.outputs.expected_rg_shared }}"
                   "${{ needs.validate-cleanup-request.outputs.expected_rg_vneta }}"
                   "${{ needs.validate-cleanup-request.outputs.expected_rg_vnetb }}")

          if [[ -n "${{ github.event.inputs.resource_groups }}" ]]; then
            # If specific resource groups provided, use those instead
            IFS=',' read -ra RG_LIST <<< "${{ github.event.inputs.resource_groups }}"
          fi

          echo "### üìã Specific Resource Groups to Delete:" >> $GITHUB_STEP_SUMMARY
          for rg in "${RG_LIST[@]}"; do
            rg=$(echo "$rg" | xargs)  # Trim whitespace
            if az group show --name "$rg" --output none 2>/dev/null; then
              echo "- ‚úÖ **$rg** (exists)" >> $GITHUB_STEP_SUMMARY

              # List resources in the group
              echo "  - Resources:" >> $GITHUB_STEP_SUMMARY
              az resource list --resource-group "$rg" --query "[].{Name:name, Type:type}" --output table | while read line; do
                echo "    - $line" >> $GITHUB_STEP_SUMMARY
              done
            else
              echo "- ‚ùå **$rg** (does not exist)" >> $GITHUB_STEP_SUMMARY
            fi
          done

        elif [[ "${{ needs.validate-cleanup-request.outputs.cleanup_type }}" == "all-matching" ]]; then
          # List all resource groups matching pattern
          PATTERN="rg-${PREFIX}-${ENV}-"

          echo "### üìã All Matching Resource Groups (pattern: ${PATTERN}*):" >> $GITHUB_STEP_SUMMARY

          MATCHING_RGS=$(az group list --query "[?starts_with(name, '${PATTERN}')].name" --output tsv)

          if [[ -n "$MATCHING_RGS" ]]; then
            while IFS= read -r rg; do
              echo "- üéØ **$rg**" >> $GITHUB_STEP_SUMMARY

              # Count resources in each group
              RESOURCE_COUNT=$(az resource list --resource-group "$rg" --query "length([*])" --output tsv)
              echo "  - Resources: $RESOURCE_COUNT" >> $GITHUB_STEP_SUMMARY

              # List key resources
              KEY_RESOURCES=$(az resource list --resource-group "$rg" --query "[?type=='Microsoft.Compute/virtualMachines' || type=='Microsoft.Network/virtualNetworks' || type=='Microsoft.Storage/storageAccounts'].{Name:name, Type:type}" --output table)
              if [[ -n "$KEY_RESOURCES" ]]; then
                echo "  - Key resources:" >> $GITHUB_STEP_SUMMARY
                echo "$KEY_RESOURCES" | tail -n +3 | while read line; do
                  echo "    - $line" >> $GITHUB_STEP_SUMMARY
                done
              fi
            done <<< "$MATCHING_RGS"
          else
            echo "- ‚ÑπÔ∏è No matching resource groups found" >> $GITHUB_STEP_SUMMARY
          fi

        else
          # List only mode
          echo "### üìã Resource Groups (List Only Mode):" >> $GITHUB_STEP_SUMMARY
          echo "- **Expected Shared:** ${{ needs.validate-cleanup-request.outputs.expected_rg_shared }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Expected VNet A:** ${{ needs.validate-cleanup-request.outputs.expected_rg_vneta }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Expected VNet B:** ${{ needs.validate-cleanup-request.outputs.expected_rg_vnetb }}" >> $GITHUB_STEP_SUMMARY

          for rg in "${{ needs.validate-cleanup-request.outputs.expected_rg_shared }}" "${{ needs.validate-cleanup-request.outputs.expected_rg_vneta }}" "${{ needs.validate-cleanup-request.outputs.expected_rg_vnetb }}"; do
            if az group show --name "$rg" --output none 2>/dev/null; then
              RESOURCE_COUNT=$(az resource list --resource-group "$rg" --query "length([*])" --output tsv)
              echo "  - ‚úÖ **$rg** exists with $RESOURCE_COUNT resources" >> $GITHUB_STEP_SUMMARY
            else
              echo "  - ‚ùå **$rg** does not exist" >> $GITHUB_STEP_SUMMARY
            fi
          done
        fi

    - name: Calculate cost savings
      run: |
        echo "### üí∞ Estimated Monthly Cost Savings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Simple cost estimation based on common resource types
        VM_COUNT=$(az vm list --query "[?resourceGroup && (starts_with(resourceGroup, 'rg-${{ needs.validate-cleanup-request.outputs.companyPrefix }}-${{ needs.validate-cleanup-request.outputs.environment }}-'))].id" --output tsv | wc -l)
        STORAGE_COUNT=$(az storage account list --query "[?resourceGroup && (starts_with(resourceGroup, 'rg-${{ needs.validate-cleanup-request.outputs.companyPrefix }}-${{ needs.validate-cleanup-request.outputs.environment }}-'))].id" --output tsv | wc -l)

        if [[ $VM_COUNT -gt 0 ]] || [[ $STORAGE_COUNT -gt 0 ]]; then
          echo "Estimated savings after cleanup:" >> $GITHUB_STEP_SUMMARY
          if [[ $VM_COUNT -gt 0 ]]; then
            echo "- **VMs:** ~$(( VM_COUNT * 30 )) USD/month ($VM_COUNT VMs)" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ $STORAGE_COUNT -gt 0 ]]; then
            echo "- **Storage:** ~$(( STORAGE_COUNT * 10 )) USD/month ($STORAGE_COUNT accounts)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Network:** ~$20 USD/month (estimated)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total estimated savings:** ~$(( VM_COUNT * 30 + STORAGE_COUNT * 10 + 20 )) USD/month" >> $GITHUB_STEP_SUMMARY
        else
          echo "- No billable resources found for cleanup" >> $GITHUB_STEP_SUMMARY
        fi

  cleanup-resources:
    name: Delete Azure Resources
    runs-on: ubuntu-latest
    needs: [validate-cleanup-request, list-resources]
    if: github.event.inputs.cleanup_type != 'list-only'

    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Delete resource groups
      id: delete
      run: |
        echo "üóëÔ∏è Starting resource deletion process..."
        DELETED_RGS=""
        FAILED_DELETIONS=""

        if [[ "${{ needs.validate-cleanup-request.outputs.cleanup_type }}" == "specific-rg" ]]; then
          # Delete specific resource groups
          RG_LIST=("${{ needs.validate-cleanup-request.outputs.expected_rg_shared }}"
                   "${{ needs.validate-cleanup-request.outputs.expected_rg_vneta }}"
                   "${{ needs.validate-cleanup-request.outputs.expected_rg_vnetb }}")

          if [[ -n "${{ github.event.inputs.resource_groups }}" ]]; then
            # If specific resource groups provided, use those instead
            IFS=',' read -ra RG_LIST <<< "${{ github.event.inputs.resource_groups }}"
          fi

          for rg in "${RG_LIST[@]}"; do
            rg=$(echo "$rg" | xargs)  # Trim whitespace
            if az group show --name "$rg" --output none 2>/dev/null; then
              echo "üóëÔ∏è Deleting resource group: $rg"
              if az group delete --name "$rg" --yes --no-wait; then
                echo "‚úÖ Deletion initiated for: $rg"
                DELETED_RGS+="$rg "
              else
                echo "‚ùå Failed to delete: $rg"
                FAILED_DELETIONS+="$rg "
              fi
            else
              echo "‚ÑπÔ∏è Resource group does not exist: $rg"
            fi
          done

        elif [[ "${{ needs.validate-cleanup-request.outputs.cleanup_type }}" == "all-matching" ]]; then
          # Delete all matching resource groups
          PREFIX="${{ needs.validate-cleanup-request.outputs.companyPrefix }}"
          ENV="${{ needs.validate-cleanup-request.outputs.environment }}"
          PATTERN="rg-${PREFIX}-${ENV}-"

          MATCHING_RGS=$(az group list --query "[?starts_with(name, '${PATTERN}')].name" --output tsv)

          if [[ -n "$MATCHING_RGS" ]]; then
            while IFS= read -r rg; do
              echo "üóëÔ∏è Deleting resource group: $rg"
              if az group delete --name "$rg" --yes --no-wait; then
                echo "‚úÖ Deletion initiated for: $rg"
                DELETED_RGS+="$rg "
              else
                echo "‚ùå Failed to delete: $rg"
                FAILED_DELETIONS+="$rg "
              fi
            done <<< "$MATCHING_RGS"
          else
            echo "‚ÑπÔ∏è No matching resource groups found for deletion"
          fi
        fi

        # Save results
        echo "deleted_rgs=$DELETED_RGS" >> $GITHUB_OUTPUT
        echo "failed_deletions=$FAILED_DELETIONS" >> $GITHUB_OUTPUT

        if [[ -n "$FAILED_DELETIONS" ]]; then
          echo "‚ùå Some deletions failed: $FAILED_DELETIONS"
          exit 1
        fi

        echo "‚úÖ All resource group deletions initiated successfully"

    - name: Monitor deletion progress
      run: |
        echo "‚è≥ Monitoring deletion progress..."
        DELETED_RGS="${{ steps.delete.outputs.deleted_rgs }}"

        if [[ -n "$DELETED_RGS" ]]; then
          echo "Monitoring deletion of: $DELETED_RGS"

          # Wait up to 30 minutes for deletions to complete
          TIMEOUT=1800  # 30 minutes
          INTERVAL=30   # Check every 30 seconds
          ELAPSED=0

          while [[ $ELAPSED -lt $TIMEOUT ]]; do
            ALL_DELETED=true

            for rg in $DELETED_RGS; do
              if az group show --name "$rg" --output none 2>/dev/null; then
                echo "‚è≥ Still deleting: $rg"
                ALL_DELETED=false
              else
                echo "‚úÖ Completed deletion: $rg"
              fi
            done

            if [[ "$ALL_DELETED" == "true" ]]; then
              echo "üéâ All resource groups have been successfully deleted!"
              break
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            echo "‚è∞ Elapsed time: $((ELAPSED/60)) minutes"
          done

          if [[ $ELAPSED -ge $TIMEOUT ]]; then
            echo "‚è∞ Timeout reached. Some deletions may still be in progress."
            echo "Check the Azure portal for final deletion status."
          fi
        fi

    - name: Generate cleanup report
      if: always()
      run: |
        echo "## üßπ Cleanup Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ needs.validate-cleanup-request.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Company Prefix:** ${{ needs.validate-cleanup-request.outputs.companyPrefix }}" >> $GITHUB_STEP_SUMMARY
        echo "**Location:** ${{ needs.validate-cleanup-request.outputs.location }}" >> $GITHUB_STEP_SUMMARY
        echo "**Cleanup Type:** ${{ needs.validate-cleanup-request.outputs.cleanup_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**Initiated by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Cleanup time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        DELETED_RGS="${{ steps.delete.outputs.deleted_rgs }}"
        FAILED_DELETIONS="${{ steps.delete.outputs.failed_deletions }}"

        if [[ -n "$DELETED_RGS" ]]; then
          echo "### ‚úÖ Successfully Deleted Resource Groups:" >> $GITHUB_STEP_SUMMARY
          for rg in $DELETED_RGS; do
            echo "- $rg" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ -n "$FAILED_DELETIONS" ]]; then
          echo "### ‚ùå Failed Deletions:" >> $GITHUB_STEP_SUMMARY
          for rg in $FAILED_DELETIONS; do
            echo "- $rg" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "### ‚ö†Ô∏è Important Notes:" >> $GITHUB_STEP_SUMMARY
        echo "- Resource deletions may take several minutes to complete" >> $GITHUB_STEP_SUMMARY
        echo "- Verify deletion completion in the Azure portal" >> $GITHUB_STEP_SUMMARY
        echo "- Some resources may have soft-delete enabled and may require additional cleanup" >> $GITHUB_STEP_SUMMARY

  send-cleanup-notification:
    name: Send Cleanup Notification
    runs-on: ubuntu-latest
    needs: [validate-cleanup-request, cleanup-resources]
    if: always()

    steps:
    - name: Send notification
      run: |
        if [[ "${{ needs.cleanup-resources.result }}" == "success" ]]; then
          echo "‚úÖ Cleanup notification: Resource cleanup completed successfully"
          echo "Environment: ${{ needs.validate-cleanup-request.outputs.environment }}"
          echo "Resources cleaned up by: ${{ github.actor }}"
          # Add your notification logic here (Slack, email, webhook, etc.)
        else
          echo "‚ùå Cleanup notification: Resource cleanup encountered issues"
          echo "Check the workflow logs for details."
          # Add your notification logic here
        fi