name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      companyPrefix:
        description: 'Company prefix for naming'
        required: true
        default: 'tmb'
        type: string
      location:
        description: 'Azure region'
        required: true
        default: 'centralus'
        type: choice
        options:
          - centralus
          - eastus
          - eastus2
          - westus2
          - westeurope
          - northeurope
      vmSize:
        description: 'VM size for production workloads'
        required: true
        default: 'Standard_D2s_v3'
        type: choice
        options:
          - Standard_D2s_v3
          - Standard_D4s_v3
          - Standard_F4s_v2
          - Standard_B4ms
      adminPublicIPAddress:
        description: 'Admin public IP for RDP access'
        required: false
        type: string
      confirm_production:
        description: 'Type "CONFIRM" to deploy to production'
        required: true
        type: string

env:
  ENVIRONMENT: prod
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

jobs:
  validate-production-request:
    name: Validate Production Deployment Request
    runs-on: ubuntu-latest

    steps:
    - name: Validate confirmation
      run: |
        if [[ "${{ github.event.inputs.confirm_production }}" != "CONFIRM" ]]; then
          echo "‚ùå Production deployment not confirmed. Please type 'CONFIRM' to proceed."
          exit 1
        fi
        echo "‚úÖ Production deployment confirmed"

    - name: Validate inputs
      run: |
        echo "üîç Validating production deployment inputs..."
        echo "Company Prefix: ${{ github.event.inputs.companyPrefix }}"
        echo "Location: ${{ github.event.inputs.location }}"
        echo "VM Size: ${{ github.event.inputs.vmSize }}"
        echo "Admin Public IP: ${{ github.event.inputs.adminPublicIPAddress }}"

        # Validate company prefix (no spaces, reasonable length)
        if [[ ! "${{ github.event.inputs.companyPrefix }}" =~ ^[a-z0-9-]{2,10}$ ]]; then
          echo "‚ùå Invalid company prefix. Must be 2-10 characters, lowercase letters, numbers, and hyphens only."
          exit 1
        fi

        echo "‚úÖ All inputs validated"

  deploy-production:
    name: Deploy Production Environment
    runs-on: ubuntu-latest
    needs: validate-production-request
    environment: production  # Requires manual approval

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set deployment variables
      id: vars
      run: |
        echo "companyPrefix=${{ github.event.inputs.companyPrefix }}" >> $GITHUB_OUTPUT
        echo "location=${{ github.event.inputs.location }}" >> $GITHUB_OUTPUT
        echo "vmSize=${{ github.event.inputs.vmSize }}" >> $GITHUB_OUTPUT
        echo "adminPublicIPAddress=${{ github.event.inputs.adminPublicIPAddress }}" >> $GITHUB_OUTPUT
        echo "deploymentName=prod-deploy-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install Azure CLI Bicep extension
      run: az bicep install

    - name: Pre-deployment validation
      run: |
        echo "üîç Running pre-deployment validation for production..."

        # Validate Bicep templates
        az bicep build --file main.bicep
        for module in modules/*.bicep; do
          az bicep build --file "$module"
        done

        # Run What-If analysis
        echo "üîç Running What-If analysis for production deployment..."
        az deployment sub what-if \
          --location "${{ steps.vars.outputs.location }}" \
          --template-file main.bicep \
          --parameters main.bicepparam \
          --parameters environment="prod" \
          --parameters location="${{ steps.vars.outputs.location }}" \
          --parameters companyPrefix="${{ steps.vars.outputs.companyPrefix }}" \
          --parameters adminPassword="${{ secrets.AZURE_ADMIN_PASSWORD }}" \
          --parameters sshPublicKey="${{ secrets.SSH_PUBLIC_KEY }}" \
          --parameters vmSize="${{ steps.vars.outputs.vmSize }}" \
          --parameters adminPublicIPAddress="${{ steps.vars.outputs.adminPublicIPAddress }}"

        echo "‚úÖ Pre-deployment validation completed"

    - name: Deploy to Production
      id: deploy
      run: |
        echo "üöÄ Deploying to Production environment..."
        echo "‚ö†Ô∏è  This is a PRODUCTION deployment!"
        echo "Company Prefix: ${{ steps.vars.outputs.companyPrefix }}"
        echo "Location: ${{ steps.vars.outputs.location }}"
        echo "VM Size: ${{ steps.vars.outputs.vmSize }}"

        DEPLOYMENT_OUTPUT=$(az deployment sub create \
          --name "${{ steps.vars.outputs.deploymentName }}" \
          --location "${{ steps.vars.outputs.location }}" \
          --template-file main.bicep \
          --parameters main.bicepparam \
          --parameters environment="prod" \
          --parameters location="${{ steps.vars.outputs.location }}" \
          --parameters companyPrefix="${{ steps.vars.outputs.companyPrefix }}" \
          --parameters adminPassword="${{ secrets.AZURE_ADMIN_PASSWORD }}" \
          --parameters sshPublicKey="${{ secrets.SSH_PUBLIC_KEY }}" \
          --parameters vmSize="${{ steps.vars.outputs.vmSize }}" \
          --parameters adminPublicIPAddress="${{ steps.vars.outputs.adminPublicIPAddress }}" \
          --output json)

        echo "‚úÖ Production deployment completed!"

        # Save deployment output
        echo "deployment_output<<EOF" >> $GITHUB_OUTPUT
        echo "$DEPLOYMENT_OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Post-deployment verification
      run: |
        echo "üîç Running comprehensive post-deployment verification..."

        RG_SHARED="rg-${{ steps.vars.outputs.companyPrefix }}-prod-shared-${{ steps.vars.outputs.location }}"
        RG_VNETA="rg-${{ steps.vars.outputs.companyPrefix }}-prod-vneta-${{ steps.vars.outputs.location }}"
        RG_VNETB="rg-${{ steps.vars.outputs.companyPrefix }}-prod-vnetb-${{ steps.vars.outputs.location }}"

        echo "Verifying resource groups..."
        az group show --name "$RG_SHARED" --output table
        az group show --name "$RG_VNETA" --output table
        az group show --name "$RG_VNETB" --output table

        echo "Verifying virtual machines..."
        az vm list --resource-group "$RG_VNETA" --output table --show-details
        az vm list --resource-group "$RG_VNETB" --output table --show-details

        echo "Verifying VNet peering..."
        az network vnet peering list --resource-group "$RG_VNETA" --vnet-name "vnet-${{ steps.vars.outputs.companyPrefix }}-prod-vneta" --output table
        az network vnet peering list --resource-group "$RG_VNETB" --vnet-name "vnet-${{ steps.vars.outputs.companyPrefix }}-prod-vnetb" --output table

        echo "Verifying storage account..."
        az storage account list --resource-group "$RG_SHARED" --output table

        echo "‚úÖ Post-deployment verification completed successfully!"

    - name: Generate production deployment report
      run: |
        echo "## üéâ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìã Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** Production üî¥" >> $GITHUB_STEP_SUMMARY
        echo "- **Company Prefix:** ${{ steps.vars.outputs.companyPrefix }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Location:** ${{ steps.vars.outputs.location }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VM Size:** ${{ steps.vars.outputs.vmSize }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Name:** ${{ steps.vars.outputs.deploymentName }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### üì¶ Resource Groups Created" >> $GITHUB_STEP_SUMMARY
        echo "- **Shared Resources:** \`rg-${{ steps.vars.outputs.companyPrefix }}-prod-shared-${{ steps.vars.outputs.location }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **VNet A (Management/AD):** \`rg-${{ steps.vars.outputs.companyPrefix }}-prod-vneta-${{ steps.vars.outputs.location }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **VNet B (Applications):** \`rg-${{ steps.vars.outputs.companyPrefix }}-prod-vnetb-${{ steps.vars.outputs.location }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### üñ•Ô∏è Virtual Machines Deployed" >> $GITHUB_STEP_SUMMARY
        echo "- **Management Server:** 1x Windows Server 2025 (${{ steps.vars.outputs.vmSize }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Active Directory Servers:** 2x Windows Server 2025 (${{ steps.vars.outputs.vmSize }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Automation Server:** 1x Ubuntu 22.04 LTS (${{ steps.vars.outputs.vmSize }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Application Servers:** 3x Windows Server 2025 (${{ steps.vars.outputs.vmSize }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Web Servers:** 3x Ubuntu 22.04 LTS (${{ steps.vars.outputs.vmSize }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### üîí Security Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **VNet Peering:** Configured between VNet A and VNet B" >> $GITHUB_STEP_SUMMARY
        echo "- **Network Security Groups:** Applied to all subnets with appropriate rules" >> $GITHUB_STEP_SUMMARY
        echo "- **Admin Access:** $(if [[ -n '${{ steps.vars.outputs.adminPublicIPAddress }}' ]]; then echo 'Restricted to specified IP'; else echo 'Internal VNet only'; fi)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### ‚ö†Ô∏è Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "- All VMs are configured with boot diagnostics" >> $GITHUB_STEP_SUMMARY
        echo "- Azure Monitor agents are installed on all VMs" >> $GITHUB_STEP_SUMMARY
        echo "- Storage accounts use Standard LRS for cost optimization" >> $GITHUB_STEP_SUMMARY
        echo "- VMs use Premium SSD for OS disks" >> $GITHUB_STEP_SUMMARY

    - name: Send production deployment notification
      if: always()
      run: |
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "‚úÖ Production deployment notification: SUCCESS"
          # Add your notification logic here (Slack, email, webhook, etc.)
        else
          echo "‚ùå Production deployment notification: FAILED"
          # Add your notification logic here
        fi